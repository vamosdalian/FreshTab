<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TagGroups 数据结构测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: #f8f9fa;
        }
        .test-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .status {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .data-display {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-family: monospace;
            overflow-x: auto;
        }
        .clear-button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>TagGroups 数据结构验证</h1>
        
        <div id="status" class="status info">正在检查数据结构...</div>
        
        <div>
            <h3>LocalStorage 中的数据:</h3>
            <div id="localStorage-data" class="data-display"></div>
            
            <button class="clear-button" onclick="clearData()">清除 LocalStorage 数据</button>
        </div>
        
        <div>
            <h3>处理后的数据:</h3>
            <div id="processed-data" class="data-display"></div>
        </div>
        
        <div>
            <h3>验证结果:</h3>
            <ul id="validation-results"></ul>
        </div>
    </div>

    <script type="module">
        function addResult(message, isError = false) {
            const results = document.getElementById('validation-results');
            const li = document.createElement('li');
            li.textContent = message;
            li.style.color = isError ? '#dc3545' : '#28a745';
            results.appendChild(li);
        }
        
        function updateStatus(type, message) {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.textContent = message;
        }
        
        window.clearData = function() {
            localStorage.removeItem('freshtab-tag-groups');
            location.reload();
        }
        
        try {
            // 检查 localStorage 中的原始数据
            const rawData = localStorage.getItem('freshtab-tag-groups');
            document.getElementById('localStorage-data').textContent = rawData || '(无数据)';
            
            if (rawData) {
                const parsedData = JSON.parse(rawData);
                addResult(`✅ LocalStorage 数据可以正常解析`);
                
                // 验证数据结构
                if (Array.isArray(parsedData)) {
                    addResult(`✅ 根级数据是数组`);
                    
                    parsedData.forEach((group, index) => {
                        if (group && typeof group === 'object') {
                            addResult(`✅ 分组 ${index + 1} 是对象`);
                            
                            if (group.tags !== undefined) {
                                if (Array.isArray(group.tags)) {
                                    addResult(`✅ 分组 ${index + 1} 的 tags 是数组 (${group.tags.length} 个标签)`);
                                } else {
                                    addResult(`❌ 分组 ${index + 1} 的 tags 不是数组: ${typeof group.tags}`, true);
                                }
                            } else {
                                addResult(`⚠️ 分组 ${index + 1} 没有 tags 属性`);
                            }
                        } else {
                            addResult(`❌ 分组 ${index + 1} 不是有效对象`, true);
                        }
                    });
                } else {
                    addResult(`❌ 根级数据不是数组: ${typeof parsedData}`, true);
                }
            } else {
                addResult(`ℹ️ LocalStorage 中没有数据，将使用默认数据`);
            }
            
            // 导入并测试 useTagGroups
            const { useTagGroups } = await import('/src/composables/useTagGroups.js');
            const { tagGroups } = useTagGroups();
            
            // 等待数据加载
            setTimeout(() => {
                document.getElementById('processed-data').textContent = JSON.stringify(tagGroups.value, null, 2);
                
                // 验证处理后的数据
                if (Array.isArray(tagGroups.value)) {
                    addResult(`✅ 处理后的数据是数组`);
                    
                    tagGroups.value.forEach((group, index) => {
                        if (Array.isArray(group.tags)) {
                            addResult(`✅ 处理后分组 ${index + 1} 的 tags 是数组`);
                        } else {
                            addResult(`❌ 处理后分组 ${index + 1} 的 tags 仍不是数组`, true);
                        }
                    });
                    
                    updateStatus('success', '数据结构验证完成！');
                } else {
                    addResult(`❌ 处理后的数据不是数组`, true);
                    updateStatus('error', '数据结构验证失败！');
                }
            }, 1000);
            
        } catch (error) {
            console.error('验证过程中出错:', error);
            addResult(`❌ 验证过程中出错: ${error.message}`, true);
            updateStatus('error', '验证过程中发生错误！');
        }
    </script>
</body>
</html>
